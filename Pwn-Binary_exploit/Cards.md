# Cards

![image](https://github.com/anhshidou/FUSec2024/assets/81132394/3c7de798-a29e-48be-9315-a0c0acb7080a)

----
# Bắt đầu giải

Trước tiên mình sẽ thử tải file có về và thử đọc source code của nó 

```
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <signal.h>
#include <string.h>
#include <time.h>
// --------------------------------------------------- SETUP

void ignore_me_init_buffering() {
	setvbuf(stdout, NULL, _IONBF, 0);
	setvbuf(stdin, NULL, _IONBF, 0);
	setvbuf(stderr, NULL, _IONBF, 0);
}

void kill_on_timeout(int sig) {
  if (sig == SIGALRM) {
  	printf("[!] Anti DoS Signal. Patch me out for testing.");
    _exit(0);
  }
}

void ignore_me_init_signal() {
	signal(SIGALRM, kill_on_timeout);
	alarm(60);
}

// --------------------------------------------------- MENU

int get_int(){
    char buf[16];
    read(0,buf,16);
    buf[15]='\0';
    int res=atoi(buf);
    return res;
}
long long current_gold=100;
void print_menu()
{
    puts("Hi i'm @nghiadt1098 and I'm rich as f*ck.");
    puts("If you correctly guess the total score of the cards in my hand, I will reward you alot of VND");
    puts("1. Play");
    puts("2. Buy flag");
    printf("Your money :%lld VND\n",current_gold);
    printf("Your choice: >");
}
// --------------------------------------------------- MAIN
void play()
{
    puts("How many cards you want me to suffle?");
    int cards =get_int();
    if (cards>10)
    {
        puts("Hell nope...");
        return;
    }
    int total=0;
    puts("How much gold you want to bet?");
    int bet=get_int();
    if (cards*bet>current_gold)
    {
        puts("Not enough $$$...");
        return;
    }
    printf("Careful!!! You will lost %d VND if lose\n",cards*bet);
    puts("Can you guess total score of the cards?");
    int guess_score =get_int();
    
    for (int i=0;i<cards;++i)
    {
        total+=rand()%13+1;//From A to K
    }
    if(total==guess_score)
    {
        current_gold+=cards*bet;
        printf("Correct!!! Here your money %d VND\n",cards*bet);
    } else
    {
        current_gold-=cards*bet;
        printf("Incorrect!!! I will take %d VND\n",cards*bet);
    }
    
}
void buy_flag()
{
    puts("This flag cost 1 billion VND");
    if (current_gold>=1000000000)
    {
        current_gold-=1000000000;
        system("cat flag");
        exit(0);
        
    } else
    {
    puts("Tien it ma doi hit fl** thom");
    exit(-1);
    }
    
}
void main(int argc, char* argv[]) {
	ignore_me_init_buffering();
	ignore_me_init_signal();
    srand(time(0));
    while(1)
    {
    	print_menu();
    	int choice =get_int();
    	switch (choice)
        {
            case 1:
                play();
                break;
            case 2:
                buy_flag();
                break;
            default:
                break;
        }
    }
  	
}


```
Tại đây ta có thể thấy hầu hết input của người đùng là nhập số. Kiểm tra kĩ source code mình thấy các biến nhập từ người dùng là `int`

Mình sẽ cho chạy thử chương trình trước

![image](https://github.com/anhshidou/FUSec2024/assets/81132394/451f42e7-4b27-4fe2-b97d-f2ba388e856c)

![image](https://github.com/anhshidou/FUSec2024/assets/81132394/6b347fb0-c1d6-44bc-b43a-69a9e6732c60)

Vậy là mình cần kiếm tới 1 tỉ thì mới mua được flag. Dựa theo source code của game thì mình phân tích được như sau:
* Lúc đầu sẽ có 2 option: chơi game, mua flag. Giới hạn input là số 1 và 2
  * Chơi game:
    * chọn số lượng quân bài bất kì,  < 10
    * Chọn số tiền cá cược, < số tiền đang có \* Số lá bài . Khởi tạo có 100 tiền
    * Tính random số ngẫu nhiên từ 1-13, ta phải input 1 số = số random. Biến nhận là `int`, không có điều kiện khác
  * Mua flag: tốn 1b
 
Tại đây mình nghĩ tới trường hợp **overflow** int \(tức cho giá trị của `input int` vượt quá giá trị `int_max` hay = `int_max` + 1\). Input khả dĩ nhất để làm điều này là input số là `int bet`.

Thử chạy thử với việc mình input như sau

![image](https://github.com/anhshidou/FUSec2024/assets/81132394/3d4e4ef2-a6b3-437e-b373-3511fabd99f9)

Việc còn lại là mua flag thôi

Bây giờ mình sẽ thử chạy trên server BTC cung cấp

![image](https://github.com/anhshidou/FUSec2024/assets/81132394/9b210933-5fd1-4aa5-b896-619fab47aa77)

Flag: `FUSec{th1s_1s_3x4ctly_h0w_my_pwn2own_l00k_l1k3!!}`

----
> Credit [wdchocopie](https://github.com/wdchocopie)

**--- End ---**
